<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Stockoi</title>
    <script type="text/javascript" src="../static/js/echarts.js"></script>
</head>
<body>
<div id="k" style="width:1280px;height:900px">
</div>
<div id="real_time" style="width:1280px;height:900px"></div>
<form id="emit">
    <input id="emit_data" type="number" value="601333"/>
</form>
</body>
<script type="text/javascript" src="../static/js/k.js"></script>
<script type="text/javascript" src="../static/js/jquery-1.9.1.min.js"></script>
<script>
    var k_chart = echarts.init(document.getElementById('k'));
    var res = {{res|safe}};
    var data0 = splitData(res);
    k_chart.setOption({
    title: {
        text: 'k线图',
        left: 0
    },
    tooltip: {
        trigger: 'axis',
        axisPointer: {
            type: 'line'
        }
    },
    legend: {
        data: ['日K', 'MA5', 'MA10', 'MA20', 'MA30']
    },
    grid: {
        left: '10%',
        right: '10%',
        bottom: '15%'
    },
    xAxis: {
        type: 'category',
        data: data0.categoryData,
        scale: true,
        boundaryGap : false,
        axisLine: {onZero: false},
        splitLine: {show: false},
        splitNumber: 20,
        min: 'dataMin',
        max: 'dataMax'
    },
    yAxis: {
        scale: true,
        splitArea: {
            show: true
        }
    },
    dataZoom: [
        {
            type: 'inside',
            start: 50,
            end: 100
        },
        {
            show: true,
            type: 'slider',
            y: '90%',
            start: 50,
            end: 100
        }
    ],
    series: [
        {
            name: '日K',
            type: 'candlestick',
            data: data0.values,
            markPoint: {
                label: {
                    normal: {
                        formatter: function (param) {
                            return param != null ? Math.round(param.value) : '';
                        }
                    }
                },
                data: [
                    {
                        name: 'XX标点',
                        coord: ['2016/01/01', 2300],
                        value: 2300,
                        itemStyle: {
                            normal: {color: 'rgb(41,60,85)'}
                        }
                    },
                    {
                        name: 'highest value',
                        type: 'max',
                        valueDim: 'highest'
                    },
                    {
                        name: 'lowest value',
                        type: 'min',
                        valueDim: 'lowest'
                    },
                    {
                        name: 'average value on close',
                        type: 'average',
                        valueDim: 'close'
                    }
                ],
                tooltip: {
                    formatter: function (param) {
                        return param.name + '<br>' + (param.data.coord || '');
                    }
                }
            },
            markLine: {
                symbol: ['none', 'none'],
                data: [
                    [
                        {
                            name: 'from lowest to highest',
                            type: 'min',
                            valueDim: 'lowest',
                            symbol: 'circle',
                            symbolSize: 10,
                            label: {
                                normal: {show: false},
                                emphasis: {show: false}
                            }
                        },
                        {
                            type: 'max',
                            valueDim: 'highest',
                            symbol: 'circle',
                            symbolSize: 10,
                            label: {
                                normal: {show: false},
                                emphasis: {show: false}
                            }
                        }
                    ],
                    {
                        name: 'min line on close',
                        type: 'min',
                        valueDim: 'close'
                    },
                    {
                        name: 'max line on close',
                        type: 'max',
                        valueDim: 'close'
                    }
                ]
            }
        },
        {
            name: 'MA5',
            type: 'line',
            data: calculateMA(5),
            smooth: true,
            lineStyle: {
                normal: {opacity: 0.5}
            }
        },
        {
            name: 'MA10',
            type: 'line',
            data: calculateMA(10),
            smooth: true,
            lineStyle: {
                normal: {opacity: 0.5}
            }
        },
        {
            name: 'MA20',
            type: 'line',
            data: calculateMA(20),
            smooth: true,
            lineStyle: {
                normal: {opacity: 0.5}
            }
        },
        {
            name: 'MA30',
            type: 'line',
            data: calculateMA(30),
            smooth: true,
            lineStyle: {
                normal: {opacity: 0.5}
            }
        },

    ]
    });
</script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
<script>
    //分时图的有效数据：当日 时间，价格，涨跌幅，成交手，成交金额
    var real_time_chart = echarts.init(document.getElementById('real_time'));
    var socket = io.connect('http://' + document.domain + ':' + location.port);
    var history_data = {{history_data|safe}};
    var data1 = splitHistoryData(history_data);

    option = {
        title: {
            text: '分时图'
        },
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                animation: true
            }
        },
        dataZoom: [
            {
                show: true,
                realtime: true,
                start: 65,
                end: 85
            },
            {
                type: 'inside',
                realtime: true,
                start: 65,
                end: 85
            }
        ],
        xAxis: {
            type: 'category',
            splitLine: {
                show: false
            },
            data:data1.categoryData
        },
        yAxis: {
            type: 'value',
            boundaryGap: ['80%', '100%'],
            scale:true,
            splitLine: {
                show: false
            }
        },
        series: [{
            name: '模拟数据',
            type: 'line',
            showSymbol: false,
            hoverAnimation: false,
            data: data1.values
        }]
    };
    real_time_chart.setOption(option);
    socket.emit('real_time', {data: document.getElementById('emit_data').getAttribute('value')});
    socket.on('res', function(msg) {
        // ['index','time','price','volume','amount','code','name','bid','ask','date']
        history_data.push([msg.data[0],msg.data[1],msg.data[2]]);
        data1 = splitHistoryData(history_data);

        real_time_chart.setOption({
            xAxis: {
                data:data1.categoryData
            },
            series: [{
                data: data1.values
            }]
        });
        if(data1.categoryData[data1.categoryData.length-1] == '15:00:00'){

        }else{

            socket.emit('real_time', {'data': document.getElementById('emit_data').getAttribute('value')});
        }
    });
</script>
</html>